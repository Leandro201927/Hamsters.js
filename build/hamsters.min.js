"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports.hamsters={version:!1,debug:!1,cache:!1,persistence:!1,maxThreads:4,tools:require("./tools.js"),wheel:require("./wheel.js"),init:function init(startOptions){function isIE(e){return new RegExp("msie"+(Number.isNaN(e)?"":"\\s"+e),"i").test(navigator.userAgent)}function setupBrowserSupport(){if(Worker&&-1===["Kindle/3.0","Mobile/8F190","IEMobile"].indexOf(navigator.userAgent)||(this.wheel.env.legacy=!0),-1!==navigator.userAgent.toLowerCase().indexOf("firefox")&&(this.maxThreads=this.maxThreads>20?20:this.maxThreads),isIE(10))try{new Worker("src/common/this.wheel.min.js").terminate(),this.wheel.env.ie10=!0}catch(e){this.wheel.env.legacy=!0}}function setupWorkerSupport(){try{this.wheel.uri=URL.createObjectURL(createBlob("("+String(giveHamsterWork())+"());"));new SharedWorker(this.wheel.uri,"SharedHamsterWheel").terminate()}catch(e){this.wheel.env.legacy=!0}}function processStartOptions(){var e=void 0;for(e in startOptions)startOptions.hasOwnProperty(e)&&(hamsters[e]=startOptions[e])}function setupHamstersEnvironment(e){this.wheel.env.browser="object"===("undefined"==typeof window?"undefined":_typeof(window)),this.wheel.env.worker="function"==typeof importScripts,this.wheel.env.node="object"===("undefined"==typeof process?"undefined":_typeof(process))&&"function"==typeof require&&!this.wheel.env.browser&&!this.wheel.env.worker&&!this.wheel.env.reactNative,this.wheel.env.reactNative=!this.wheel.env.node&&"object"===("undefined"==typeof global?"undefined":_typeof(global)),this.wheel.env.shell=!(this.wheel.env.browser||this.wheel.env.node||this.wheel.env.worker||this.wheel.env.reactNative),"undefined"!=typeof navigator&&(this.maxThreads=navigator.hardwareConcurrency),void 0!==startOptions&&processStartOptions(),this.wheel.env.browser&&setupBrowserSupport(),this.wheel.env.worker&&setupWorkerSupport(),(this.wheel.env.reactNative||this.wheel.env.node)&&(global.self=global),(this.wheel.env.shell||"undefined"==typeof Worker)&&(this.wheel.env.legacy=!0),"undefined"==typeof Uint8Array&&(this.wheel.env.transferrable=!1),e()}function spawnHamsters(){if("undefined"!=typeof URL&&(this.wheel.uri=URL.createObjectURL(createBlob("("+String(giveHamsterWork())+")();"))),this.persistence){var e=this.maxThreads;for(e;e>0;e--)this.wheel.this.push(this.wheel.newHamster())}}function giveHamsterWork(){return this.wheel.env.worker?workerWorker:worker}function createBlob(e){if(!self.Blob){self.BlobBuilder=self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder;var t=new BlobBuilder;return t.append([e],{type:"application/javascript"}),t.getBlob()}return new Blob([e],{type:"application/javascript"})}function workerWorker(){self.addEventListener("connect",function(e){var port=e.ports[0];port.start(),port.addEventListener("message",function(e){self.rtn={success:!0,data:[]},self.params=e.data,self.fn=eval("("+params.fn+")"),fn&&self.fn(),self.params.dataType&&"na"!=self.params.dataType&&(self.rtn.data=self.processDataType(self.params.dataType,self.rtn.data),self.rtn.dataType=self.params.dataType),port.postMessage({results:self.rtn})},!1)},!1)}function worker(){function e(e,t){var r={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array,uint8clamped:Uint8ClampedArray,int32:Int32Array,int16:Int16Array,int8:Int8Array,float32:Float32Array,float64:Float64Array};return r[e]?new r[e](t):t}self.onmessage=function(t){self.params=t.data,self.rtn={data:[],dataType:self.params.dataType};var r=new Function(self.params.fn);r&&r(),self.params.dataType?(self.rtn.data=e(self.params.dataType,self.rtn.data),self.postMessage({results:self.rtn},[rtn.data.buffer])):self.postMessage({results:self.rtn})}}function legacyHamsterWheel(e,t,r,n,a,s,i,o){var u=this;this.wheel.trackThread(a,this.wheel.queue.running,s),(o||this.debug)&&this.wheel.trackInput(e,s,a,t),this.wheel.legacyProcessor(function(e,t,i){u.wheel.clean(a,s),a.output[s]=i.data,0===a.workers.length&&a.count===a.threads&&(n(u.wheel.getOutput(a.output,r,i.dataType)),u.wheel.tasks[a.id]=null,u.cache&&!1!==o&&u.wheel.memoize(a.fn,a.input,i.data,i.dataType))}),a.count+=1}function hamsterWheel(e,t,r,n,a,s,i,o){if(this.maxThreads===this.wheel.queue.running.length)return void this.wheel.poolThread(e,t,s,n,a,r,o);(o||this.debug)&&this.wheel.trackInput(e,s,a,t),i||(i=this.persistence?this.wheel.hamsters[this.wheel.queue.running.length]:this.wheel.newHamster()),this.wheel.trainHamster(s,r,n,a,i,o),this.wheel.trackThread(a,this.wheel.queue.running,s),t.array=e,this.wheel.feedHamster(i,t),a.count+=1,"verbose"===this.debug&&console.info("Spawning Hamster #"+s+" @ "+(new Date).getTime())}function chewGarbage(){delete this.init,startOptions=null}setupHamstersEnvironment(function(){(void 0).wheel.env.legacy?(void 0).wheel.newWheel=legacyHamsterWheel:((void 0).wheel.newWheel=hamsterWheel,spawnHamsters()),chewGarbage()})}},exports.tools={splitArray:function(e,t){var r=0,n=[],a=Math.ceil(e.length/t);if(e.slice)for(;r<e.length;)n.push(e.slice(r,r+=a));else for(;r<e.length;)n.push(e.subarray(r,r+=a));return n},loop:function loop(input,onSuccess){var params={run:prepareFunction(input.operator),init:input.startIndex||0,limit:input.limit,array:input.array,incrementBy:input.incrementBy||1,dataType:input.dataType||null,worker:hamsters.wheel.env.worker};hamsters.run(params,function(){var operator=self.params.run;"string"==typeof operator&&(operator=params.worker?eval("("+operator+")"):new Function(operator)),params.limit||(params.limit=params.array.length);var i=params.init;for(i;i<params.limit;i+=params.incrementBy)rtn.data[i]=operator(params.array[i])},function(e){onSuccess(e)},input.threads,1,input.dataType)},prepareFunction:function(e){if(!hamsters.wheel.env.legacy&&(e=String(e),!hamsters.wheel.env.worker)){var t=e.indexOf("{")+1,r=e.length-1;return e.substring(t,r)}return e},parseJson:function(e,t){hamsters.run({input:e},function(){rtn.data=JSON.parse(params.input)},function(e){t(e[0])},1)},stringifyJson:function(e,t){hamsters.run({input:e},function(){rtn.data=JSON.stringify(params.input)},function(e){t(e)},1)},randomArray:function(e,t){var r={count:e};hamsters.run(r,function(){for(;r.count>0;)rtn.data[rtn.data.length]=Math.round(99*Math.random()+1),r.count-=1},function(e){t(e)})},aggregate:function(e,t){if(!t||!hamsters.wheel.env.transferrable)return e.reduce(function(e,t){return e.concat(t)});var r=0,n=e.length,a=0;for(r;r<n;r+=1)a+=e[r].length;var s=hamsters.wheel.processDataType(t,a),i=0;for(r=0;r<n;r+=1)s.set(e[r],i),i+=e[r].length;return s}},exports.wheel={env:Object.create({legacy:!1,node:!1,shell:!1,worker:!1,browser:!1,ie10:!1,transferrable:!0}),queue:Object.create({running:[],pending:[]}),cache:Object.create({}),hamsters:[],tasks:[],errors:[],uri:null,newHamster:function(){return env.worker?new SharedWorker(uri,"SharedHamsterWheel"):env.ie10?new Worker("src/common/wheel.min.js"):new Worker(uri)},checkCache:function(e,t,r){var n=cache[e];if(n&&n[0]===t&&n[2]===r)return n},memoize:function(e,t,r,n){cache[e]=[t,r,n]},sort:function(e,t){switch(t){case"desc":case"asc":return Array.prototype.sort.call(e,function(e,r){return"asc"===t?e-r:r-e});case"ascAlpha":return e.sort();case"descAlpha":return e.reverse();default:return e}},work:function(e,t,r,n,a,s,i,o){var u=t.array||null;t.array&&1!==e.threads&&(u=hamsters.tools.splitArray(t.array,e.threads));var l={},p=void 0;for(p in t)t.hasOwnProperty(p)&&"array"!==p&&(l[p]=t[p]);l.fn=hamsters.tools.prepareFunction(r),l.dataType=s;for(var h=0;h<e.threads;)u&&1!==e.threads?newWheel(u[h],l,a,n,e,e.count,null,i):newWheel(u,l,a,n,e,e.count,null,i),h+=1},newTask:function(e,t,r,n,a,s){return tasks.push({id:e,workers:[],count:0,threads:t,input:[],dataType:n||null,fn:a,output:[],order:r||null,callback:s}),tasks[e]},trackInput:function(e,t,r,n){r.input.push({input:e,workerid:t,taskid:r.id,params:n,start:(new Date).getTime()})},trackThread:function(e,t,r){e.workers.push(r),t.push(r)},poolThread:function(e,t,r,n,a,s,i){queue.pending.push({memoize:i,input:e,params:t,workerid:r,callback:n,task:a,aggregate:s})},legacyProcessor:function(e,t,r){setTimeout(function(){self.rtn={success:!0,data:[]},self.params=e,self.params.array=t,self.params.fn(),self.params.dataType&&"na"!=self.params.dataType&&(self.rtn.data=processDataType(self.params.dataType,self.rtn.data),self.rtn.dataType=self.params.dataType),r(self.rtn)},4)},getOutput:function(e,t,r){return t&&e.length<=20?hamsters.tools.aggregate(e,r):e},processQueue:function(e,t){t&&newWheel(t.input,t.params,t.aggregate,t.callback,t.task,t.workerid,e,t.memoize)},clean:function(e,t){queue.running.splice(queue.running.indexOf(t),1),e.workers.splice(e.workers.indexOf(t),1)},trainHamster:function(e,t,r,n,a,s){function i(i,o){clean(n,e),o=i.data.results,n.output[e]=o.data,"verbose"===hamsters.debug&&console.info("Hamster #"+e+" finished @ "+i.timeStamp),0===n.workers.length&&n.count===n.threads&&(r(n.order?sort(getOutput(n.output,t,o.dataType),n.order):getOutput(n.output,t,o.dataType)),hamsters.debug&&console.info("Execution Complete! Elapsed: "+(i.timeStamp-n.input[0].start)/1e3+"s"),tasks[n.id]=null,hamsters.cache&&s&&(n.output[e]&&!n.output[e].slice?s(n.fn,n.input[0].input,normalizeArray(output),o.dataType):s(n.fn,n.input[0].input,getOutput(n.output,t,o.dataType),o.dataType))),0!==queue.pending.length?processQueue(a,queue.pending.shift()):hamsters.persistence||env.worker||a.terminate()}function o(t){env.worker||a.terminate(),errors.push({msg:"Error Hamster #"+e+": Line "+t.lineno+" in "+t.filename+": "+t.message}),console.error("Error Hamster #"+e+": Line "+t.lineno+" in "+t.filename+": "+t.message)}env.worker?(a.port.onmessage=i,a.port.onerror=o):(a.onmessage=i,a.onerror=o)},processData:function(e,t){var r={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array,uint8clamped:Uint8ClampedArray,int32:Int32Array,int16:Int16Array,int8:Int8Array,float32:Float32Array,float64:Float64Array};return r[e]?new r[e](t):e},processDataType:function(e,t){return env.transferrable?processData(e,t):t},feedHamster:function(e,t){if(env.worker)return e.port.postMessage(t);if(env.ie10)return e.postMessage(t);var r=[],n=void 0;for(n in t)t.hasOwnProperty(n)&&t[n]&&t[n].buffer&&r.push(t[n].buffer);return e.postMessage(t,r)}};