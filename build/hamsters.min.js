"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},hamstersTools={splitArray:function(e,r){var t=0,a=[],s=Math.ceil(e.length/r);if(e.slice)for(;t<e.length;)a.push(e.slice(t,t+=s));else for(;t<e.length;)a.push(e.subarray(t,t+=s));return a},loop:function loop(input,onSuccess){var params={run:prepareFunction(input.operator),init:input.startIndex||0,limit:input.limit,array:input.array,incrementBy:input.incrementBy||1,dataType:input.dataType||null,worker:hamsters.wheel.env.worker};hamsters.run(params,function(){var operator=self.params.run;"string"==typeof operator&&(operator=params.worker?eval("("+operator+")"):new Function(operator)),params.limit||(params.limit=params.array.length);var i=params.init;for(i;i<params.limit;i+=params.incrementBy)rtn.data[i]=operator(params.array[i])},function(e){onSuccess(e)},input.threads,1,input.dataType)},prepareFunction:function(e){if(!hamsters.wheel.env.legacy&&(e=String(e),!hamsters.wheel.env.worker)){var r=e.indexOf("{")+1,t=e.length-1;return e.substring(r,t)}return e},parseJson:function(e,r){hamsters.run({input:e},function(){rtn.data=JSON.parse(params.input)},function(e){r(e[0])},1)},stringifyJson:function(e,r){hamsters.run({input:e},function(){rtn.data=JSON.stringify(params.input)},function(e){r(e)},1)},randomArray:function(e,r){var t={count:e};hamsters.run(t,function(){for(;t.count>0;)rtn.data[rtn.data.length]=Math.round(99*Math.random()+1),t.count-=1},function(e){r(e)})},aggregate:function(e,r){if(!r||!hamsters.wheel.env.transferrable)return e.reduce(function(e,r){return e.concat(r)});var t=0,a=e.length,s=0;for(t;t<a;t+=1)s+=e[t].length;var n=hamsters.wheel.processDataType(r,s),o=0;for(t=0;t<a;t+=1)n.set(e[t],o),o+=e[t].length;return n}};exports=hamstersTools;var hamstersWheel={env:Object.create({legacy:!1,node:!1,shell:!1,worker:!1,browser:!1,ie10:!1,transferrable:!0}),queue:Object.create({running:[],pending:[]}),cache:Object.create({}),hamsters:[],tasks:[],errors:[],uri:null,newHamster:function(){return env.worker?new SharedWorker(uri,"SharedHamsterWheel"):env.ie10?new Worker("src/common/wheel.min.js"):new Worker(uri)},checkCache:function(e,r,t){var a=cache[e];if(a&&a[0]===r&&a[2]===t)return a},memoize:function(e,r,t,a){cache[e]=[r,t,a]},sort:function(e,r){switch(r){case"desc":case"asc":return Array.prototype.sort.call(e,function(e,t){return"asc"===r?e-t:t-e});case"ascAlpha":return e.sort();case"descAlpha":return e.reverse();default:return e}},work:function(e,r,t,a,s,n,o,i){var u=r.array||null;r.array&&1!==e.threads&&(u=hamsters.tools.splitArray(r.array,e.threads));var l={},p=void 0;for(p in r)r.hasOwnProperty(p)&&"array"!==p&&(l[p]=r[p]);l.fn=hamsters.tools.prepareFunction(t),l.dataType=n;for(var h=0;h<e.threads;)u&&1!==e.threads?newWheel(u[h],l,s,a,e,e.count,null,o):newWheel(u,l,s,a,e,e.count,null,o),h+=1},newTask:function(e,r,t,a,s,n){return tasks.push({id:e,workers:[],count:0,threads:r,input:[],dataType:a||null,fn:s,output:[],order:t||null,callback:n}),tasks[e]},trackInput:function(e,r,t,a){t.input.push({input:e,workerid:r,taskid:t.id,params:a,start:(new Date).getTime()})},trackThread:function(e,r,t){e.workers.push(t),r.push(t)},poolThread:function(e,r,t,a,s,n,o){queue.pending.push({memoize:o,input:e,params:r,workerid:t,callback:a,task:s,aggregate:n})},legacyProcessor:function(e,r,t){setTimeout(function(){self.rtn={success:!0,data:[]},self.params=e,self.params.array=r,self.params.fn(),self.params.dataType&&"na"!=self.params.dataType&&(self.rtn.data=processDataType(self.params.dataType,self.rtn.data),self.rtn.dataType=self.params.dataType),t(self.rtn)},4)},getOutput:function(e,r,t){return r&&e.length<=20?hamsters.tools.aggregate(e,t):e},processQueue:function(e,r){r&&newWheel(r.input,r.params,r.aggregate,r.callback,r.task,r.workerid,e,r.memoize)},clean:function(e,r){queue.running.splice(queue.running.indexOf(r),1),e.workers.splice(e.workers.indexOf(r),1)},trainHamster:function(e,r,t,a,s,n){function o(o,i){clean(a,e),i=o.data.results,a.output[e]=i.data,"verbose"===hamsters.debug&&console.info("Hamster #"+e+" finished @ "+o.timeStamp),0===a.workers.length&&a.count===a.threads&&(t(a.order?sort(getOutput(a.output,r,i.dataType),a.order):getOutput(a.output,r,i.dataType)),hamsters.debug&&console.info("Execution Complete! Elapsed: "+(o.timeStamp-a.input[0].start)/1e3+"s"),tasks[a.id]=null,hamsters.cache&&n&&(a.output[e]&&!a.output[e].slice?n(a.fn,a.input[0].input,normalizeArray(output),i.dataType):n(a.fn,a.input[0].input,getOutput(a.output,r,i.dataType),i.dataType))),0!==queue.pending.length?processQueue(s,queue.pending.shift()):hamsters.persistence||env.worker||s.terminate()}function i(r){env.worker||s.terminate(),errors.push({msg:"Error Hamster #"+e+": Line "+r.lineno+" in "+r.filename+": "+r.message}),console.error("Error Hamster #"+e+": Line "+r.lineno+" in "+r.filename+": "+r.message)}env.worker?(s.port.onmessage=o,s.port.onerror=i):(s.onmessage=o,s.onerror=i)},processData:function(e,r){var t={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array,uint8clamped:Uint8ClampedArray,int32:Int32Array,int16:Int16Array,int8:Int8Array,float32:Float32Array,float64:Float64Array};return t[e]?new t[e](r):e},processDataType:function(e,r){return env.transferrable?processData(e,r):r},feedHamster:function(e,r){if(env.worker)return e.port.postMessage(r);if(env.ie10)return e.postMessage(r);var t=[],a=void 0;for(a in r)r.hasOwnProperty(a)&&r[a]&&r[a].buffer&&t.push(r[a].buffer);return e.postMessage(r,t)}};exports=hamstersWheel;var hamsters={version:!1,debug:!1,cache:!1,persistence:!1,maxThreads:4,tools:require("./hamsters-tools"),wheel:require("./hamsters-wheel"),init:function init(startOptions){function isIE(e){return new RegExp("msie"+(Number.isNaN(e)?"":"\\s"+e),"i").test(navigator.userAgent)}function setupBrowserSupport(){if(Worker&&-1===["Kindle/3.0","Mobile/8F190","IEMobile"].indexOf(navigator.userAgent)||(hamsters.wheel.env.legacy=!0),-1!==navigator.userAgent.toLowerCase().indexOf("firefox")&&(hamsters.maxThreads=hamsters.maxThreads>20?20:hamsters.maxThreads),isIE(10))try{new Worker("src/common/hamsters.wheel.min.js").terminate(),hamsters.wheel.env.ie10=!0}catch(e){hamsters.wheel.env.legacy=!0}}function setupWorkerSupport(){try{hamsters.wheel.uri=URL.createObjectURL(createBlob("("+String(giveHamsterWork())+"());"));new SharedWorker(hamsters.wheel.uri,"SharedHamsterWheel").terminate()}catch(e){hamsters.wheel.env.legacy=!0}}function processStartOptions(){var e=void 0;for(e in startOptions)startOptions.hasOwnProperty(e)&&(this[e]=startOptions[e])}function setupHamstersEnvironment(e){hamsters.wheel.env.browser="object"===("undefined"==typeof window?"undefined":_typeof(window)),hamsters.wheel.env.worker="function"==typeof importScripts,hamsters.wheel.env.node="object"===("undefined"==typeof process?"undefined":_typeof(process))&&"function"==typeof require&&!hamsters.wheel.env.browser&&!hamsters.wheel.env.worker&&!hamsters.wheel.env.reactNative,hamsters.wheel.env.reactNative=!hamsters.wheel.env.node&&"object"===("undefined"==typeof global?"undefined":_typeof(global)),hamsters.wheel.env.shell=!(hamsters.wheel.env.browser||hamsters.wheel.env.node||hamsters.wheel.env.worker||hamsters.wheel.env.reactNative),"undefined"!=typeof navigator&&(hamsters.maxThreads=navigator.hardwareConcurrency),void 0!==startOptions&&processStartOptions(),hamsters.wheel.env.browser&&setupBrowserSupport(),hamsters.wheel.env.worker&&setupWorkerSupport(),(hamsters.wheel.env.reactNative||hamsters.wheel.env.node)&&(global.self=global),(hamsters.wheel.env.shell||"undefined"==typeof Worker)&&(hamsters.wheel.env.legacy=!0),"undefined"==typeof Uint8Array&&(hamsters.wheel.env.transferrable=!1),e()}function spawnHamsters(){if("undefined"!=typeof URL&&(hamsters.wheel.uri=URL.createObjectURL(createBlob("("+String(giveHamsterWork())+")();"))),hamsters.persistence){var e=hamsters.maxThreads;for(e;e>0;e--)hamsters.wheel.hamsters.push(hamsters.wheel.newHamster())}}function giveHamsterWork(){return hamsters.wheel.env.worker?workerWorker:worker}function createBlob(e){if(!self.Blob){self.BlobBuilder=self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder;var r=new BlobBuilder;return r.append([e],{type:"application/javascript"}),r.getBlob()}return new Blob([e],{type:"application/javascript"})}function workerWorker(){self.addEventListener("connect",function(e){var port=e.ports[0];port.start(),port.addEventListener("message",function(e){self.rtn={success:!0,data:[]},self.params=e.data,self.fn=eval("("+params.fn+")"),fn&&self.fn(),self.params.dataType&&"na"!=self.params.dataType&&(self.rtn.data=self.processDataType(self.params.dataType,self.rtn.data),self.rtn.dataType=self.params.dataType),port.postMessage({results:self.rtn})},!1)},!1)}function worker(){function e(e,r){var t={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array,uint8clamped:Uint8ClampedArray,int32:Int32Array,int16:Int16Array,int8:Int8Array,float32:Float32Array,float64:Float64Array};return t[e]?new t[e](r):r}self.onmessage=function(r){self.params=r.data,self.rtn={data:[],dataType:self.params.dataType};var t=new Function(self.params.fn);t&&t(),self.params.dataType?(self.rtn.data=e(self.params.dataType,self.rtn.data),self.postMessage({results:self.rtn},[rtn.data.buffer])):self.postMessage({results:self.rtn})}}function legacyHamsterWheel(e,r,t,a,s,n,o,i){hamsters.wheel.trackThread(s,hamsters.wheel.queue.running,n),(i||hamsters.debug)&&hamsters.wheel.trackInput(e,n,s,r),hamsters.wheel.legacyProcessor(function(e,r,o){hamsters.wheel.clean(s,n),s.output[n]=o.data,0===s.workers.length&&s.count===s.threads&&(a(hamsters.wheel.getOutput(s.output,t,o.dataType)),hamsters.wheel.tasks[s.id]=null,hamsters.cache&&!1!==i&&hamsters.wheel.memoize(s.fn,s.input,o.data,o.dataType))}),s.count+=1}function hamsterWheel(e,r,t,a,s,n,o,i){if(hamsters.maxThreads===hamsters.wheel.queue.running.length)return void hamsters.wheel.poolThread(e,r,n,a,s,t,i);(i||hamsters.debug)&&hamsters.wheel.trackInput(e,n,s,r),o||(o=hamsters.persistence?hamsters.wheel.hamsters[hamsters.wheel.queue.running.length]:hamsters.wheel.newHamster()),hamsters.wheel.trainHamster(n,t,a,s,o,i),hamsters.wheel.trackThread(s,hamsters.wheel.queue.running,n),r.array=e,hamsters.wheel.feedHamster(o,r),s.count+=1,"verbose"===hamsters.debug&&console.info("Spawning Hamster #"+n+" @ "+(new Date).getTime())}function chewGarbage(){delete hamsters.init,startOptions=null}setupHamstersEnvironment(function(){hamsters.wheel.env.legacy?hamsters.wheel.newWheel=legacyHamsterWheel:(hamsters.wheel.newWheel=hamsterWheel,spawnHamsters()),chewGarbage()})}};exports.hamsters=hamsters;